
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta http-equiv="Cache-Control" content="no-store" />
<title>BoA / Starfish Sample Call Flow</title>
</head>
<script src="/api/wsc.js" type="text/javascript"></script>
<script type="text/javascript">

function onMessage(message){
	console.log("Got a message...");
	
	var content = message.payload.content;
	var action = message.header.action;
    var type = message.control.type;
	
	document.getElementById("ReceiveField").value = 
	document.getElementById("ReceiveField").value + content + "\n\n";
	
}

function CallExtension() {
  	console.log("CallExtension...");
    CallExtension.superclass.constructor.apply(this, arguments);
}
  
console.log("wsc.extend(CallExtension, wsc.Call);");
wsc.extend(CallExtension, wsc.Call);
	
CallExtension.prototype.onMessage = onMessage;

  var CallPackageExtension = function(){
    console.log("In CallPackageExtension constructor for **info**.");
    CallPackageExtension.superclass.constructor.apply(this, arguments);
  };

  CallPackageExtension.prototype.prepareCall = function (session, callConfig, caller, callee) {
    console.log("In CallPackageExtension for **info**, prepareCall method.");
    return new CallExtension(session, callConfig, caller, callee);
  };
  
  console.log("wsc.extend(CallPackageExtension,wsc.CallPackage);");
  wsc.extend(CallPackageExtension,wsc.CallPackage);



function onLoad(){
	wsc.setLogger(console);
	wsc.setLogLevel(wsc.LOGLEVEL.DEBUG);
	console.log("onLoad...");
	webSocket = localStorage.getItem("webSocket");	
	if(webSocket==null){
		webSocket = "ws://" + window.location.hostname  + ":" + window.location.port + "/ws/webrtc/guest";
	}
	document.getElementById("webSocket").value = webSocket;
	
	userName = localStorage.getItem("userName");
	document.getElementById("userName").value = userName;
		
}

function onConnect(){
	console.log("onConnect...");

	this.userIdentity = document.getElementById("userName").value;

	localStorage.setItem("webSocket", document.getElementById("webSocket").value);
	localStorage.setItem("userName", document.getElementById("userName").value);
	localStorage.setItem("connected", true);
	
	document.getElementById("Connect").disabled = true;
	document.getElementById("Disconnect").disabled = false;
	

	console.log("wsc.extend(CallExtension, wsc.Call);");
	wsc.extend(CallExtension, wsc.Call);	
	CallExtension.prototype.onMessage = onMessage;
	
	console.log("userName: "+userName);
	console.log("webSocket: "+webSocket);	
	
//	wscSession = new wsc.ExtensibleSession(userName, webSocket, onSessionSuccess, onSessionError);
	wscSession = new wsc.Session(userName, webSocket, onSessionSuccess, onSessionError);
    wscSession.onSessionStateChange = onSessionStateChange;

	authHandler = new wsc.AuthHandler(wscSession);
    authHandler.refresh = refreshAuth;
    
    callHandler = new wsc.CallPackage(wscSession);
    callHandler.onIncomingCall =function(callobj,callConfig){onIncomingCall(callobj,callConfig)};
    callHandler.onResurrect = onResurrect;
	callHandler.onMessage = onMessage;



	
    
}

function onDisconnect(){
	console.log("onDisconnect...");
	localStorage.setItem("connected", false);
	document.getElementById("Connect").disabled = false;
	document.getElementById("Disconnect").disabled = true;
	
    wscSession.close();
}

function onReset(){
	console.log("onReset...");
	localStorage.removeItem("webSocket");
	localStorage.removeItem("userName");
	localStorage.removeItem("connected");
	document.getElementById("Connect").disabled = false;
	document.getElementById("Disconnect").disabled = false;	
}

function onSend(){
	console.log("onSend...");
	
	document.getElementById("ReceiveField").value = "";
	
	var content = document.getElementById("SendField").value;
//	var target = document.getElementById("endpoint").value;
	var target = "talkbac@oracle.com";
	var initiator = document.getElementById("userName").value;
	
	var msg ={
		"control" : {
			"type" : "message",
			"version" : "1.0",
//			"sequence" : this.session.getLastOutboundSeq() + 1,
//			"ack_sequence" : this.session.lastServerSequence,
//			"subsession_id" : this.subSessionId,
			"package_type" : "call"
			},
        "header" : {
        	"action" : "message",
        	"initiator" : initiator,
        	"target" : target
        	},
		"payload" : {
			"content" : content
			}
	};
	
	wscSession.sendMessage(new wsc.Message(msg), true);
	

}

function onSessionSuccess() {
	console.log("onSessionSuccess...");
}

function onSessionError(error) {
	console.log("onSessionError...");
}

function onIncomingCall(callobj, remoteCallConfig) {
	console.log("onIncomingCall...");
}

function onSessionStateChange(sessionState) {
	console.log("onSessionStateChange... " + sessionState);
}

 function refreshAuth(authType,authHeaders){
 	console.log("refreshAuth... " + authType);
 
/*   	var authInfo = null;
  	if(authType==wsc.AUTHTYPE.SERVICE){
   		authInfo = getServiceAuth(authHeaders);
  	}else if(authType==wsc.AUTHTYPE.TURN){
   		authInfo = getTurnAuth();
   		console.log("Current the turn auth server is: "+JSON.stringify(authInfo));
  	}
 */ 
	return authInfo;
};

function onResurrect(resurrectedCall) {
 	console.log("onResurrect... ");
}

</script>
<body  onload="javascript:onLoad()">
<h1>Connect:</h1>
<form name="form1" method="post" action="">
  <table width="0%" border="0" id="table1">
    <tr>
      <td><div align="right">WebSocket URL:</div></td>
      <td><input name="webSocket" type="text" id="webSocket" size="45"></td>
    </tr>
    <tr>
      <td><div align="right">User Name:</div></td>
      <td><input name="userName" type="text" id="userName" size="45"></td>
    </tr>
    <tr>
      <td colspan="2"><div align="center">
        <table width="100%" border="0">
          <tr>
            <td><div align="center">
              <input type="button" name="Connect" id="Connect" value="Connect" onClick="javascript:onConnect()">
            </div></td>
            <td><div align="center">
              <input type="button" name="Disconnect" id="Disconnect" value="Disconnect" onClick="javascript:onDisconnect()">
            </div></td>
            <td><div align="center">
              <input type="reset" name="Reset" id="Reset" value="Reset" onClick="javascript:onReset()">
            </div></td>
          </tr>
        </table>
      </div></td>
    </tr>
    
    
  </table>
</form>
<h1>Message:</h1>
<form name="form2" method="post" action="">
  <table width="0%" border="0">
    <tr>
      <td><div align="right">Send:</div></td>
      <td><textarea name="SendField" cols="45" rows="3" id="SendField" style="height: 199px; "></textarea></td>
    </tr>
    <tr>
      <td><div align="right">Receive:</div></td>
      <td><label for="SendField"></label><textarea readonly name="ReceiveField" cols="45" rows="15" id="ReceiveField"></textarea>
      </td>
    </tr>
    <tr>
      <td colspan="2"><div align="center">
        <input type="button" name="Send" id="Send" value="Send" onClick="javascript:onSend()">
      </div></td>
    </tr>
  </table>
</form>
<p>&nbsp;</p>
</body>
</html>